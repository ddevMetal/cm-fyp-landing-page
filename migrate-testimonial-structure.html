<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate Testimonial Structure</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        button.warning {
            background-color: #ff9800;
        }
        button.warning:hover {
            background-color: #e68900;
        }
        .log {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #4CAF50;
            color: white;
        }
        .error {
            background-color: #f44336;
            color: white;
        }
        .info {
            background-color: #2196F3;
            color: white;
        }
        .warning {
            background-color: #ff9800;
            color: white;
        }
        .section {
            border-left: 4px solid #4CAF50;
            padding-left: 20px;
            margin: 20px 0;
        }
        .code-block {
            background-color: #1e1e1e;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <h1>üîÑ Testimonial Structure Migration Tool</h1>
    
    <div class="container">
        <h2>üìã Migration Overview</h2>
        <div class="section">
            <h3>üë• Users Collection Changes:</h3>
            <div class="code-block">
// BEFORE: No testimonial structure
// AFTER: Add nested testimonials
"testimonials": {
  "basic": {
    "review": null,
    "starsRating": 0,
    "surveyIsComplete": false,
    "reviewSubmittedOn": null
  },
  "premium": {
    "review": null,
    "starsRating": 0,
    "surveyIsComplete": false,
    "reviewSubmittedOn": null
  }
}
            </div>
        </div>
        
        <div class="section">
            <h3>üè¢ Business Users Collection Changes:</h3>
            <div class="code-block">
// BEFORE: Individual fields
"review": "...",
"starsRating": 5,
"isComplete": true,
"reviewSubmittedOn": "..."

// AFTER: Single testimonial object
"testimonial": {
  "review": "...",
  "starsRating": 5,
  "surveyIsComplete": true,
  "reviewSubmittedOn": "..."
}
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üîç Step 1: Analyze Current Data</h2>
        <button onclick="analyzeUsers()">Analyze Users Collection</button>
        <button onclick="analyzeBusinessUsers()">Analyze Business Users Collection</button>
        <button onclick="analyzeAll()">Analyze Both Collections</button>
    </div>

    <div class="container">
        <h2>üîÑ Step 2: Migrate Data</h2>
        <button onclick="migrateUsers()" class="warning">Migrate Users (Add Testimonials Structure)</button>
        <button onclick="migrateBusinessUsers()" class="warning">Migrate Business Users (Restructure Fields)</button>
        <button onclick="migrateAll()" class="warning">Migrate Both Collections</button>
    </div>

    <div class="container">
        <h2>‚úÖ Step 3: Verify Migration</h2>
        <button onclick="verifyUsers()">Verify Users Migration</button>
        <button onclick="verifyBusinessUsers()">Verify Business Users Migration</button>
        <button onclick="verifyAll()">Verify All Migrations</button>
    </div>

    <div class="container">
        <h2>üóëÔ∏è Step 4: Cleanup (Optional)</h2>
        <button onclick="cleanupBusinessUsers()" class="danger">Remove Old Fields from Business Users</button>
        <p><strong>‚ö†Ô∏è Warning:</strong> Cleanup will permanently remove old fields. Make sure migration was successful first!</p>
    </div>

    <div class="container">
        <h2>üìä Status</h2>
        <div id="status"></div>
    </div>

    <div class="container">
        <h2>üìù Activity Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAIFV7ynXUzA0p-CrmVOE2lFRgaf_9g_k4",
            authDomain: "fyp-25-s2-09.firebaseapp.com",
            projectId: "fyp-25-s2-09",
            storageBucket: "fyp-25-s2-09.appspot.com",
            messagingSenderId: "838641447649",
            appId: "1:838641447649:web:6ddfb234b3d445f16dbda0",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Default testimonial structures
        const defaultTestimonials = {
            "basic": {
                "review": null,
                "starsRating": 0,
                "surveyIsComplete": false,
                "reviewSubmittedOn": null
            },
            "premium": {
                "review": null,
                "starsRating": 0,
                "surveyIsComplete": false,
                "reviewSubmittedOn": null
            }
        };

        const defaultBusinessTestimonial = {
            "review": null,
            "starsRating": 0,
            "surveyIsComplete": false,
            "reviewSubmittedOn": null
        };

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // ANALYSIS FUNCTIONS
        async function analyzeUsers() {
            log('üîç Analyzing Users collection...');
            showStatus('Analyzing Users collection...', 'info');
            
            try {
                const snapshot = await db.collection('users').get();
                const totalUsers = snapshot.size;
                let usersWithTestimonials = 0;
                let usersNeedingMigration = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.testimonials) {
                        usersWithTestimonials++;
                    } else {
                        usersNeedingMigration++;
                    }
                });

                log(`üìä Users Analysis Results:`);
                log(`   ‚Ä¢ Total users: ${totalUsers}`);
                log(`   ‚Ä¢ Users with testimonials structure: ${usersWithTestimonials}`);
                log(`   ‚Ä¢ Users needing migration: ${usersNeedingMigration}`);
                
                showStatus(`Users Analysis Complete: ${usersNeedingMigration}/${totalUsers} need migration`, 'success');
            } catch (error) {
                log(`‚ùå Error analyzing users: ${error.message}`);
                showStatus('Error analyzing users', 'error');
            }
        }

        async function analyzeBusinessUsers() {
            log('üîç Analyzing Business Users collection...');
            showStatus('Analyzing Business Users collection...', 'info');
            
            try {
                const snapshot = await db.collection('businessUsers').get();
                const totalBusinessUsers = snapshot.size;
                let usersWithNewStructure = 0;
                let usersWithOldStructure = 0;
                let usersNeedingMigration = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasOldFields = data.hasOwnProperty('review') || data.hasOwnProperty('starsRating') || 
                                        data.hasOwnProperty('isComplete') || data.hasOwnProperty('reviewSubmittedOn');
                    const hasNewStructure = data.testimonial;

                    if (hasNewStructure) {
                        usersWithNewStructure++;
                    }
                    if (hasOldFields) {
                        usersWithOldStructure++;
                        if (!hasNewStructure) {
                            usersNeedingMigration++;
                        }
                    }
                });

                log(`üìä Business Users Analysis Results:`);
                log(`   ‚Ä¢ Total business users: ${totalBusinessUsers}`);
                log(`   ‚Ä¢ Users with new testimonial structure: ${usersWithNewStructure}`);
                log(`   ‚Ä¢ Users with old individual fields: ${usersWithOldStructure}`);
                log(`   ‚Ä¢ Users needing migration: ${usersNeedingMigration}`);
                
                showStatus(`Business Users Analysis Complete: ${usersNeedingMigration}/${totalBusinessUsers} need migration`, 'success');
            } catch (error) {
                log(`‚ùå Error analyzing business users: ${error.message}`);
                showStatus('Error analyzing business users', 'error');
            }
        }

        async function analyzeAll() {
            await analyzeUsers();
            log(''); // Empty line
            await analyzeBusinessUsers();
        }

        // MIGRATION FUNCTIONS
        async function migrateUsers() {
            log('üîÑ Starting Users testimonial structure migration...');
            showStatus('Migrating Users collection...', 'warning');
            
            try {
                const snapshot = await db.collection('users').get();
                const batch = db.batch();
                let migratedCount = 0;
                let skippedCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    if (!data.testimonials) {
                        // Add testimonials structure
                        batch.update(doc.ref, {
                            testimonials: defaultTestimonials
                        });
                        migratedCount++;
                        log(`‚úÖ Queued migration for user: ${doc.id}`);
                    } else {
                        skippedCount++;
                        log(`‚è≠Ô∏è Skipped user ${doc.id} (already has testimonials structure)`);
                    }
                });

                if (migratedCount > 0) {
                    await batch.commit();
                    log(`üéâ Successfully migrated ${migratedCount} users!`);
                    log(`‚è≠Ô∏è Skipped ${skippedCount} users (already migrated)`);
                    showStatus(`Users migration completed: ${migratedCount} migrated, ${skippedCount} skipped`, 'success');
                } else {
                    log(`‚ÑπÔ∏è No users needed migration`);
                    showStatus('No users needed migration', 'info');
                }
            } catch (error) {
                log(`‚ùå Error migrating users: ${error.message}`);
                showStatus('Error migrating users', 'error');
            }
        }

        async function migrateBusinessUsers() {
            log('üîÑ Starting Business Users testimonial structure migration...');
            showStatus('Migrating Business Users collection...', 'warning');
            
            try {
                const snapshot = await db.collection('businessUsers').get();
                const batch = db.batch();
                let migratedCount = 0;
                let skippedCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Check if user has old structure and doesn't have new structure
                    const hasOldFields = data.hasOwnProperty('review') || data.hasOwnProperty('starsRating') || 
                                        data.hasOwnProperty('isComplete') || data.hasOwnProperty('reviewSubmittedOn');
                    const hasNewStructure = data.testimonial;

                    if (hasOldFields && !hasNewStructure) {
                        // Migrate old fields to new structure
                        const newTestimonial = {
                            review: data.review || null,
                            starsRating: data.starsRating || 0,
                            surveyIsComplete: data.isComplete || false,
                            reviewSubmittedOn: data.reviewSubmittedOn || null
                        };

                        batch.update(doc.ref, {
                            testimonial: newTestimonial
                        });
                        
                        migratedCount++;
                        log(`‚úÖ Queued migration for business user: ${doc.id}`);
                        log(`   üìù Migrated: review="${newTestimonial.review}", stars=${newTestimonial.starsRating}, complete=${newTestimonial.surveyIsComplete}`);
                    } else if (hasNewStructure) {
                        skippedCount++;
                        log(`‚è≠Ô∏è Skipped business user ${doc.id} (already has new testimonial structure)`);
                    } else {
                        // No old fields, add default testimonial structure
                        batch.update(doc.ref, {
                            testimonial: defaultBusinessTestimonial
                        });
                        migratedCount++;
                        log(`‚úÖ Queued default testimonial for business user: ${doc.id}`);
                    }
                });

                if (migratedCount > 0) {
                    await batch.commit();
                    log(`üéâ Successfully migrated ${migratedCount} business users!`);
                    log(`‚è≠Ô∏è Skipped ${skippedCount} business users (already migrated)`);
                    showStatus(`Business Users migration completed: ${migratedCount} migrated, ${skippedCount} skipped`, 'success');
                } else {
                    log(`‚ÑπÔ∏è No business users needed migration`);
                    showStatus('No business users needed migration', 'info');
                }
            } catch (error) {
                log(`‚ùå Error migrating business users: ${error.message}`);
                showStatus('Error migrating business users', 'error');
            }
        }

        async function migrateAll() {
            await migrateUsers();
            log(''); // Empty line
            await migrateBusinessUsers();
        }

        // VERIFICATION FUNCTIONS
        async function verifyUsers() {
            log('üîç Verifying Users migration...');
            showStatus('Verifying Users migration...', 'info');
            
            try {
                const snapshot = await db.collection('users').get();
                let successCount = 0;
                let errorCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    if (data.testimonials && 
                        data.testimonials.basic && 
                        data.testimonials.premium &&
                        data.testimonials.basic.hasOwnProperty('surveyIsComplete') &&
                        data.testimonials.premium.hasOwnProperty('surveyIsComplete')) {
                        successCount++;
                    } else {
                        errorCount++;
                        log(`‚ùå User ${doc.id} missing proper testimonials structure`);
                    }
                });

                log(`üìä Users Verification Results:`);
                log(`   ‚úÖ Successfully migrated: ${successCount}`);
                log(`   ‚ùå Migration issues: ${errorCount}`);
                
                if (errorCount === 0) {
                    showStatus(`Users verification successful: ${successCount}/${successCount + errorCount} users properly migrated`, 'success');
                } else {
                    showStatus(`Users verification found issues: ${errorCount} users need attention`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Error verifying users: ${error.message}`);
                showStatus('Error verifying users', 'error');
            }
        }

        async function verifyBusinessUsers() {
            log('üîç Verifying Business Users migration...');
            showStatus('Verifying Business Users migration...', 'info');
            
            try {
                const snapshot = await db.collection('businessUsers').get();
                let successCount = 0;
                let errorCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    if (data.testimonial && 
                        data.testimonial.hasOwnProperty('surveyIsComplete') &&
                        data.testimonial.hasOwnProperty('reviewSubmittedOn')) {
                        successCount++;
                    } else {
                        errorCount++;
                        log(`‚ùå Business User ${doc.id} missing proper testimonial structure`);
                    }
                });

                log(`üìä Business Users Verification Results:`);
                log(`   ‚úÖ Successfully migrated: ${successCount}`);
                log(`   ‚ùå Migration issues: ${errorCount}`);
                
                if (errorCount === 0) {
                    showStatus(`Business Users verification successful: ${successCount}/${successCount + errorCount} users properly migrated`, 'success');
                } else {
                    showStatus(`Business Users verification found issues: ${errorCount} users need attention`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Error verifying business users: ${error.message}`);
                showStatus('Error verifying business users', 'error');
            }
        }

        async function verifyAll() {
            await verifyUsers();
            log(''); // Empty line
            await verifyBusinessUsers();
        }

        // CLEANUP FUNCTIONS
        async function cleanupBusinessUsers() {
            if (!confirm('‚ö†Ô∏è WARNING: This will permanently remove old testimonial fields (review, starsRating, isComplete, reviewSubmittedOn) from Business Users. Make sure migration was successful first!\n\nProceed with cleanup?')) {
                log('üö´ Cleanup cancelled by user');
                return;
            }

            log('üßπ Starting Business Users field cleanup...');
            showStatus('Cleaning up old fields from Business Users...', 'warning');
            
            try {
                const snapshot = await db.collection('businessUsers').get();
                const batch = db.batch();
                let cleanedCount = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Check if old fields exist
                    const hasOldFields = data.hasOwnProperty('review') || data.hasOwnProperty('starsRating') || 
                                        data.hasOwnProperty('isComplete') || data.hasOwnProperty('reviewSubmittedOn');
                    
                    if (hasOldFields && data.testimonial) {
                        // Remove old fields
                        batch.update(doc.ref, {
                            review: firebase.firestore.FieldValue.delete(),
                            starsRating: firebase.firestore.FieldValue.delete(),
                            isComplete: firebase.firestore.FieldValue.delete(),
                            reviewSubmittedOn: firebase.firestore.FieldValue.delete()
                        });
                        
                        cleanedCount++;
                        log(`üßπ Queued cleanup for business user: ${doc.id}`);
                    }
                });

                if (cleanedCount > 0) {
                    await batch.commit();
                    log(`üéâ Successfully cleaned up ${cleanedCount} business users!`);
                    showStatus(`Cleanup completed: Removed old fields from ${cleanedCount} business users`, 'success');
                } else {
                    log(`‚ÑπÔ∏è No business users needed cleanup`);
                    showStatus('No business users needed cleanup', 'info');
                }
            } catch (error) {
                log(`‚ùå Error during cleanup: ${error.message}`);
                showStatus('Error during cleanup', 'error');
            }
        }

        // Initialize
        log('üîÑ Testimonial Structure Migration Tool loaded successfully');
        log('üìã Step 1: Analyze your current data structure');
        log('üìã Step 2: Run migration for each collection');
        log('üìã Step 3: Verify the migration was successful');
        log('üìã Step 4: Optionally cleanup old fields');
        showStatus('Ready to migrate testimonial structures', 'info');
    </script>
</body>
</html>
